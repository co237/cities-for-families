<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cities for Families</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f26;
            --bg-elevated: #242b33;
            --text-primary: #f7f9f9;
            --text-secondary: #8b98a5;
            --text-muted: #6e7c8a;
            --accent: #ff6b4a;
            --accent-glow: rgba(255, 107, 74, 0.15);
            --decline: #ff4757;
            --growth: #26de81;
            --serif: 'Source Serif 4', Georgia, serif;
            --sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--sans);
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 2rem;
            background: rgba(15, 20, 25, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        nav .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: var(--serif);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--text-primary);
        }

        /* Hero Section */
        .hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 30% 20%, var(--accent-glow) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(38, 222, 129, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero-content {
            max-width: 900px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .hero-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--bg-elevated);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 2rem;
        }

        .hero h1 {
            font-family: var(--serif);
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 1.5rem;
        }

        .hero h1 .highlight {
            color: var(--accent);
        }

        .hero-stat {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin: 3rem 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: var(--serif);
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--decline);
            line-height: 1;
        }

        .stat-number.positive {
            color: var(--growth);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            max-width: 180px;
        }

        .hero-description {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-10px); }
            60% { transform: translateX(-50%) translateY(-5px); }
        }

        /* Sections */
        section {
            padding: 6rem 2rem;
        }

        .section-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: 3rem;
        }

        .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .section-title {
            font-family: var(--serif);
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .section-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
        }

        /* Key Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s, border-color 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.1);
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .stat-card .value {
            font-family: var(--serif);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card .value.decline {
            color: var(--decline);
        }

        .stat-card .value.growth {
            color: var(--growth);
        }

        .stat-card .context {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .data-highlights {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .data-highlights h3 {
            font-family: var(--serif);
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
        }

        .highlight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .highlight-stat {
            font-family: var(--serif);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
            min-width: 70px;
        }

        .highlight-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .highlight-text strong {
            color: var(--text-primary);
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-card);
        }

        .fertility-context {
            margin-bottom: 2rem;
        }

        .context-box {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent);
        }

        .context-box h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .context-box p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin: 0;
        }

        .context-box strong {
            color: var(--text-primary);
        }

        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .decline-chart #decline-chart {
            height: 400px;
        }

        .fertility-takeaways {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .fertility-takeaways {
                grid-template-columns: 1fr;
            }
        }

        .takeaway {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .takeaway-stat {
            font-family: var(--serif);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--decline);
            line-height: 1;
        }

        .takeaway:last-child .takeaway-stat {
            color: var(--accent);
        }

        .takeaway-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
            color: var(--text-primary);
        }

        .takeaway-context {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-family: var(--serif);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        #fertility-chart {
            width: 100%;
            height: 400px;
        }

        /* Map Section */
        .map-section {
            background: var(--bg-dark);
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .map-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-btn:hover {
            border-color: rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        .map-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .map-container {
            position: relative;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #map {
            width: 100%;
            display: block;
        }

        .county {
            stroke: rgba(255,255,255,0.1);
            stroke-width: 0.25;
            transition: opacity 0.2s;
        }

        .county.major {
            stroke: rgba(255,255,255,0.2);
            stroke-width: 0.5;
            cursor: pointer;
        }

        .county.major:hover {
            stroke: var(--text-primary);
            stroke-width: 1.5;
        }

        .state-border {
            fill: none;
            stroke: rgba(255,255,255,0.15);
            stroke-width: 0.75;
            pointer-events: none;
        }

        .map-tooltip {
            position: absolute;
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            min-width: 280px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .map-tooltip.visible {
            opacity: 1;
        }

        .map-tooltip .county-name {
            font-family: var(--serif);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .map-tooltip .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .map-tooltip .stat-row:last-child {
            border-bottom: none;
        }

        .map-tooltip .stat-label {
            color: var(--text-muted);
        }

        .map-tooltip .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .map-tooltip .stat-value.negative {
            color: var(--decline);
        }

        .map-tooltip .stat-value.positive {
            color: var(--growth);
        }

        .map-legend {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--bg-elevated);
            padding: 1rem 1.25rem;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.7rem;
        }

        .map-legend h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .legend-scale {
            display: flex;
            height: 10px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.25rem;
            width: 160px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            width: 160px;
            color: var(--text-muted);
        }

        .map-legend .note {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
        }

        /* Insights Section */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .insight-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .insight-card h3 {
            font-family: var(--serif);
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }

        .insight-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Coverage Section */
        .coverage-section {
            background: var(--bg-dark);
        }

        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }

        .coverage-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.05);
            text-decoration: none;
            display: block;
            transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .coverage-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }

        .coverage-card.featured {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(255,107,74,0.1) 0%, var(--bg-card) 100%);
            border-color: var(--accent);
        }

        @media (max-width: 768px) {
            .coverage-card.featured {
                grid-column: span 1;
            }
        }

        .coverage-source {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .coverage-card h3 {
            font-family: var(--serif);
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.4;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .coverage-card.featured h3 {
            font-size: 1.15rem;
        }

        .coverage-author {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        .coverage-context {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .doom-loop-callout {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            border-left: 4px solid var(--decline);
        }

        .doom-loop-callout blockquote {
            font-family: var(--serif);
            font-size: 1.15rem;
            font-style: italic;
            line-height: 1.7;
            color: var(--text-primary);
            margin: 0 0 1rem 0;
        }

        .doom-loop-callout cite {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: normal;
        }

        /* Research Section */
        .research-section {
            background: var(--bg-card);
        }

        .research-intro {
            max-width: 800px;
            margin-bottom: 3rem;
            padding: 1.5rem;
            background: var(--bg-elevated);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .research-intro p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.7;
            margin: 0;
        }

        .research-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .research-card {
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 1.75rem;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, border-color 0.3s;
        }

        .research-card:hover {
            transform: translateY(-4px);
            border-color: rgba(255,255,255,0.1);
        }

        .research-card.featured {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(255,107,74,0.08) 0%, var(--bg-dark) 100%);
        }

        .research-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .research-meta .org {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            background: var(--accent-glow);
            padding: 0.35rem 0.75rem;
            border-radius: 100px;
        }

        .research-meta .year {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .research-card h3 {
            font-family: var(--serif);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .research-card .authors {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-style: italic;
        }

        .research-card .description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.7;
            flex-grow: 1;
        }

        .research-card .key-finding {
            font-size: 0.8rem;
            background: var(--bg-elevated);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            color: var(--text-secondary);
            border-left: 3px solid var(--growth);
        }

        .research-card .key-finding strong {
            color: var(--growth);
        }

        .research-card .policy-recs {
            font-size: 0.8rem;
            background: rgba(255,107,74,0.1);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 0.75rem 0;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent);
        }

        .research-card .policy-recs strong {
            color: var(--accent);
        }

        .research-link {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-decoration: none;
            margin-top: auto;
            padding-top: 0.5rem;
            transition: opacity 0.2s;
        }

        .research-link:hover {
            opacity: 0.8;
        }

        .research-themes {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .research-themes h3 {
            font-family: var(--serif);
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .theme {
            text-align: center;
            padding: 1rem;
        }

        .theme-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-glow);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--accent);
        }

        .theme h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .theme p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .research-disclaimer {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .research-disclaimer p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0;
            line-height: 1.6;
        }

        .research-disclaimer strong {
            color: var(--text-secondary);
        }

        /* Footer */
        footer {
            padding: 4rem 2rem;
            background: var(--bg-card);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .footer-grid {
                grid-template-columns: 1fr;
            }
        }

        .footer-about h3 {
            font-family: var(--serif);
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .footer-about p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .footer-links h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .footer-links ul {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: var(--text-primary);
        }

        .footer-bottom {
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .credit-link {
            color: var(--accent);
            text-decoration: none;
        }

        .credit-link:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
            }

            .nav-links {
                display: none;
            }

            section {
                padding: 4rem 1rem;
            }

            .hero-stat {
                gap: 2rem;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .map-legend {
                position: relative;
                bottom: auto;
                right: auto;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-inner">
            <a href="#" class="logo">Cities for Families</a>
            <ul class="nav-links">
                <li><a href="#fertility">Fertility Rates</a></li>
                <li><a href="#map">County Map</a></li>
                <li><a href="#coverage">Coverage</a></li>
                <li><a href="#research">Research</a></li>
                <li><a href="#about">About</a></li>
            </ul>
        </div>
    </nav>

    <section class="hero">
        <div class="hero-content">
            <span class="hero-label">Research Brief</span>
            <h1>America's Cities Are <span class="highlight">Losing Families</span></h1>
            <p class="hero-description">
                Parents are increasingly choosing to decamp for the suburbs&mdash;or opt out of parenthood altogether. Policymakers should take notice.
            </p>
            <div class="hero-stat">
                <div class="stat-item">
                    <div class="stat-number">-18.3%</div>
                    <div class="stat-label">Fertility rate decline in large urban counties since 2011</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">-484K</div>
                    <div class="stat-label">Fewer children under 5 in large urban counties since 2020</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">3.1x</div>
                    <div class="stat-label">Urban fertility decline vs. rural areas</div>
                </div>
            </div>
        </div>
        <div class="scroll-indicator">
            <span>Scroll to explore</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M19 12l-7 7-7-7"/>
            </svg>
        </div>
    </section>

    <section id="overview">
        <div class="section-inner">
            <div class="section-header">
                <div class="section-label">The Scale of Change</div>
                <h2 class="section-title">Urban Counties Bear the Brunt</h2>
                <p class="section-subtitle">
                    While all county types have seen declines in young children, large urban counties have experienced dramatically steeper drops.
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">Large Urban Counties</div>
                    <div class="value decline">-7.2%</div>
                    <div class="context">Under-5 population change (2020-2024)</div>
                </div>
                <div class="stat-card">
                    <div class="label">Suburban Counties</div>
                    <div class="value decline">-1.7%</div>
                    <div class="context">Under-5 population change (2020-2024)</div>
                </div>
                <div class="stat-card">
                    <div class="label">Rural Counties</div>
                    <div class="value decline">-2.6%</div>
                    <div class="context">Under-5 population change (2020-2024)</div>
                </div>
                <div class="stat-card">
                    <div class="label">Nationwide Total</div>
                    <div class="value decline">-803K</div>
                    <div class="context">Fewer children under 5 since April 2020</div>
                </div>
            </div>

            <div class="data-highlights">
                <h3>Key Numbers</h3>
                <div class="highlights-grid">
                    <div class="highlight-item">
                        <div class="highlight-stat">-18.9%</div>
                        <div class="highlight-text"><strong>Manhattan</strong> lost nearly one-fifth of its under-5 population since 2020</div>
                    </div>
                    <div class="highlight-item">
                        <div class="highlight-stat">-80K</div>
                        <div class="highlight-text"><strong>Los Angeles County</strong> lost more young children than any other county in absolute terms</div>
                    </div>
                    <div class="highlight-item">
                        <div class="highlight-stat">28.8</div>
                        <div class="highlight-text"><strong>Manhattan's fertility rate</strong>&mdash;roughly half that of some Midwest and Texas metros</div>
                    </div>
                    <div class="highlight-item">
                        <div class="highlight-stat">12%</div>
                        <div class="highlight-text"><strong>Urban-rural gap</strong> in fertility rates, nearly double what it was in 2011</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="fertility" class="chart-section">
        <div class="section-inner">
            <div class="section-header">
                <div class="section-label">Fertility Trends</div>
                <h2 class="section-title">The Urban-Rural Fertility Gap</h2>
                <p class="section-subtitle">
                    Fertility rates have declined across all county types since 2011, but the decline has been steepest in large urban areas&mdash;creating a widening gap.
                </p>
            </div>

            <div class="fertility-context">
                <div class="context-box">
                    <h4>Understanding the Numbers</h4>
                    <p>A fertility rate of <strong>45</strong> means 45 births per 1,000 women ages 15-49 per year. For context, a rate of ~65-70 is typically needed for a population to replace itself (accounting for mortality, childlessness, etc.). In 2011, large urban and rural counties had nearly identical rates (~55). By 2024, a significant gap had emerged.</p>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container main-chart">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Fertility Rate Over Time (2011-2024)</div>
                            <div class="chart-subtitle">Births per 1,000 women ages 15-49</div>
                        </div>
                        <div class="legend" id="chart-legend"></div>
                    </div>
                    <div id="fertility-chart"></div>
                </div>

                <div class="chart-container decline-chart">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Fertility Rate Decline by County Type</div>
                            <div class="chart-subtitle">Percent change, 2011 to 2024</div>
                        </div>
                    </div>
                    <div id="decline-chart"></div>
                </div>
            </div>

            <div class="fertility-takeaways">
                <div class="takeaway">
                    <div class="takeaway-stat">-18.3%</div>
                    <div class="takeaway-label">Large urban county fertility decline</div>
                    <div class="takeaway-context">From 55.2 to 45.1 births per 1,000 women</div>
                </div>
                <div class="takeaway">
                    <div class="takeaway-stat">-5.8%</div>
                    <div class="takeaway-label">Rural county fertility decline</div>
                    <div class="takeaway-context">From 54.8 to 51.6 births per 1,000 women</div>
                </div>
                <div class="takeaway">
                    <div class="takeaway-stat">3.1x</div>
                    <div class="takeaway-label">Larger decline in cities</div>
                    <div class="takeaway-context">Urban fertility fell 3x faster than rural</div>
                </div>
            </div>
        </div>
    </section>

    <section id="map" class="map-section">
        <div class="section-inner">
            <div class="section-header">
                <div class="section-label">Geographic Distribution</div>
                <h2 class="section-title">Under-5 Population Change by County</h2>
                <p class="section-subtitle">
                    Showing the 83 large urban counties as defined by the Economic Innovation Group's geographic typology.
                </p>
            </div>

            <div class="map-controls">
                <button class="map-btn active" data-mode="absolute">Absolute Change</button>
                <button class="map-btn" data-mode="percent">Percent Change</button>
                <button class="map-btn" data-mode="fertility">Fertility Rate 2024</button>
            </div>

            <div class="map-container">
                <svg id="map"></svg>
                <div class="map-tooltip" id="tooltip"></div>
                <div class="map-legend" id="legend"></div>
            </div>
        </div>
    </section>

    <section id="coverage" class="coverage-section">
        <div class="section-inner">
            <div class="section-header">
                <div class="section-label">In The News</div>
                <h2 class="section-title">The Crisis Gets Attention</h2>
                <p class="section-subtitle">
                    Major outlets are covering the urban family exodus. Here's what they're saying.
                </p>
            </div>

            <div class="coverage-grid">
                <a href="https://www.theatlantic.com/ideas/archive/2024/08/cities-children-families-population/679589/" class="coverage-card featured" target="_blank">
                    <div class="coverage-source">The Atlantic</div>
                    <h3>"Progressives do have a family problem... The steady march of the childless city is the result of urban policy, conceived by, written by, and enacted by liberals."</h3>
                    <p class="coverage-author">Derek Thompson</p>
                    <p class="coverage-context">Thompson argues that pricey housing, poor schooling, and declining public safety are making it "just too hard" to raise a family in the city&mdash;and these are policy choices.</p>
                </a>

                <a href="https://www.city-journal.org/article/the-childless-city" class="coverage-card" target="_blank">
                    <div class="coverage-source">City Journal</div>
                    <h3>"Increasingly, America's great cities are evolving into playgrounds for the rich, traps for the poor, and way stations for the ambitious young."</h3>
                    <p class="coverage-author">Joel Kotkin</p>
                    <p class="coverage-context">Documents the growing chasm between family-oriented suburbanites and childless urbanites first identified in the 1960s.</p>
                </a>

                <a href="https://gothamist.com/news/young-families-are-fleeing-nyc-rising-child-care-and-housing-costs-are-to-blame" class="coverage-card" target="_blank">
                    <div class="coverage-source">Gothamist</div>
                    <h3>"Young families are fleeing NYC. Rising child care and housing costs are to blame."</h3>
                    <p class="coverage-author">Gothamist Staff</p>
                    <p class="coverage-context">The median asking rent for family-sized apartments with three or more bedrooms is now nearly $5,000 a month in New York City.</p>
                </a>

                <a href="https://www.amny.com/oped/new-york-citys-future-is-leaving-family/" class="coverage-card" target="_blank">
                    <div class="coverage-source">amNewYork</div>
                    <h3>"New York City's future is leaving, family by family"</h3>
                    <p class="coverage-author">Op-Ed</p>
                    <p class="coverage-context">As families leave, school enrollment declines, the tax base erodes, and neighborhood stability crumbles.</p>
                </a>

                <a href="https://eig.org/young-families-exodus-2025/" class="coverage-card" target="_blank">
                    <div class="coverage-source">Economic Innovation Group</div>
                    <h3>"Young families have stopped leaving big cities, for now"</h3>
                    <p class="coverage-author">Connor O'Brien</p>
                    <p class="coverage-context">After years of exodus, 2024 saw some stabilization&mdash;but cities haven't recovered the families they lost.</p>
                </a>

                <a href="https://www.chalkbeat.org/newyork/2025/10/22/nyc-families-flee-child-care-school-crisis-mamdani-agenda/" class="coverage-card" target="_blank">
                    <div class="coverage-source">Chalkbeat</div>
                    <h3>"NYC families are fleeing before kindergarten. Free pre-K isn't always enough to keep them."</h3>
                    <p class="coverage-author">Chalkbeat New York</p>
                    <p class="coverage-context">40% of families surveyed left the NYC school system because they moved out of the city entirely.</p>
                </a>
            </div>

            <div class="doom-loop-callout">
                <blockquote>
                    "I'm deeply worried about a family-exodus doom loop. When the population of young kids in a city falls 10 or 20 percent in just a few years, that's a potential political earthquake. Almost overnight, there are fewer parents around to fight for better schools, local playgrounds, or all the other mundane amenities families care about."
                </blockquote>
                <cite>&mdash; Connor O'Brien, Economic Innovation Group, in The Atlantic</cite>
            </div>
        </div>
    </section>

    <section id="research" class="research-section">
        <div class="section-inner">
            <div class="section-header">
                <div class="section-label">Research & Ideas</div>
                <h2 class="section-title">What Can Be Done?</h2>
                <p class="section-subtitle">
                    A growing body of research explores how to make cities more welcoming to families. Here's a curated collection of important ideas from across the policy landscape.
                </p>
            </div>

            <div class="research-intro">
                <p>Researchers, developers, and policy advocates have proposed a range of solutions to address the urban family exodus. While these ideas span the ideological spectrum and not all are mutually compatible, they represent the leading edge of thinking on family-friendly housing policy.</p>
            </div>

            <div class="research-grid">
                <div class="research-card featured">
                    <div class="research-meta">
                        <span class="org">Institute for Family Studies</span>
                        <span class="year">2024-2025</span>
                    </div>
                    <h3>Homes for Young Families (Part 1)</h3>
                    <p class="authors">Lyman Stone & Bobby Fijan</p>
                    <p class="description">
                        A survey of 8,800+ Americans finds that 79% prefer single-family homes, yet housing has become dramatically less affordable&mdash;median home prices rose from 5 to 11.4 times young adult incomes since 1969. Homeownership for under-35s fell from 50% to just 30%.
                    </p>
                    <div class="key-finding">
                        <strong>Key finding:</strong> Apartment-dwellers under 35 average just 0.3 children, compared to 0.6 for those in other housing.
                    </div>
                    <div class="policy-recs">
                        <strong>Policy recommendations:</strong> Reform restrictive zoning at all levels from HOAs to federal policy; increase housing supply in high-cost metros; eliminate regulatory barriers to single-family construction.
                    </div>
                    <a href="https://ifstudies.org/report-brief/homes-for-young-families-a-pro-family-housing-agenda" class="research-link" target="_blank">Read Part 1 &rarr;</a>
                </div>

                <div class="research-card featured">
                    <div class="research-meta">
                        <span class="org">Institute for Family Studies</span>
                        <span class="year">September 2025</span>
                    </div>
                    <h3>Homes for Young Families (Part 2)</h3>
                    <p class="authors">Lyman Stone & Bobby Fijan</p>
                    <p class="description">
                        Examines why apartments aren't meeting family needs. In 2024, over one-third of new housing was in buildings with 20+ units&mdash;the highest since 1974&mdash;yet apartments are shrinking (down 20% since 2007) and studios rose from 10% to 15% of construction. Survey of 6,288 Americans reveals families would pay premium rents for larger units.
                    </p>
                    <div class="key-finding">
                        <strong>Key finding:</strong> 3+ bedroom apartments fell from 7-11% of construction in the 2000s to just 5% today.
                    </div>
                    <div class="policy-recs">
                        <strong>Policy recommendations:</strong> Incentivize developers to build larger units; reform building codes to allow more efficient layouts; require minimum bedroom counts in new developments; provide tax incentives for family-sized apartments.
                    </div>
                    <a href="https://ifstudies.org/report-brief/homes-for-young-families-part-2" class="research-link" target="_blank">Read Part 2 &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">Center for Building in North America</span>
                        <span class="year">2023-2025</span>
                    </div>
                    <h3>Single-Stair Reform</h3>
                    <p class="authors">Stephen Smith</p>
                    <p class="description">
                        North American building codes require two staircases in most apartment buildings, adding ~$200,000 per building and making family-sized units economically unfeasible. Single-stair buildings allow apartments with windows on multiple sides, enabling larger, more livable units. A Pew study found single-stair buildings with sprinklers are equally safe.
                    </p>
                    <div class="key-finding">
                        <strong>Policy momentum:</strong> 11+ states and 3 cities have passed single-stair legislation since 2023.
                    </div>
                    <a href="https://www.pew.org/-/media/assets/2025/05/single-stair_report_summary.pdf" class="research-link" target="_blank">Read the research &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">American Enterprise Institute</span>
                        <span class="year">2024</span>
                    </div>
                    <h3>The 9 Million Family-Friendly Apartments Hiding in Plain Sight</h3>
                    <p class="authors">Ed Pinto et al.</p>
                    <p class="description">
                        Townhomes represent an overlooked "Goldilocks" housing type&mdash;more affordable than detached homes ($100K+ savings) while more family-friendly than large apartment buildings. AEI proposes legalizing smaller lots, allowing townhomes by right, and permitting mixed housing downtown to unlock this housing type.
                    </p>
                    <div class="key-finding">
                        <strong>Key finding:</strong> Townhome households are 2x more likely to have children than large apartment building residents.
                    </div>
                    <a href="https://www.aei.org/articles/the-9-million-family-friendly-apartments-hiding-in-plain-sight/" class="research-link" target="_blank">Read the article &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">Manhattan Institute</span>
                        <span class="year">2023</span>
                    </div>
                    <h3>Making Metros Family-Friendly</h3>
                    <p class="authors">Robert VerBruggen</p>
                    <p class="description">
                        Ranks America's metro areas on factors related to family-friendliness, documenting how major cities have become increasingly childless. The analysis finds this trend accelerated during the pandemic due to remote work, crime concerns, and housing costs.
                    </p>
                    <div class="key-finding">
                        <strong>Warning sign:</strong> American cities were already relatively light on kids even before the current exodus began.
                    </div>
                    <a href="https://manhattan.institute/article/new-report-and-rankings-making-metros-family-friendly" class="research-link" target="_blank">Read the report &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">Niskanen Center</span>
                        <span class="year">2023-2024</span>
                    </div>
                    <h3>An Agenda for Abundant Housing</h3>
                    <p class="authors">Alex Armlovich & Andrew Justus</p>
                    <p class="description">
                        Argues the current housing crisis is "purely political"&mdash;at least 70% of residentially zoned land in nearly every major city bans apartments. Advocates for federal incentives tied to local zoning reform, inspired by Senator Todd Young's bipartisan YIMBY Act.
                    </p>
                    <div class="key-finding">
                        <strong>Core argument:</strong> Today's housing scarcity, unlike 19th-century shortages, can be solved through policy reform.
                    </div>
                    <a href="https://www.niskanencenter.org/written-testimony-for-the-2023-joint-legislative-budget-hearing-on-housing/" class="research-link" target="_blank">Read the testimony &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">Ethics & Public Policy Center</span>
                        <span class="year">2023</span>
                    </div>
                    <h3>Yes in My Backyard&mdash;and in My Frontyard</h3>
                    <p class="authors">Patrick T. Brown</p>
                    <p class="description">
                        Argues that pro-family advocates cannot rely on cultural exhortation alone&mdash;they must engage with housing policy. Proposes that conservatives embrace zoning reform as consistent with property rights and family formation goals.
                    </p>
                    <div class="key-finding">
                        <strong>Key insight:</strong> "Seeking to address delayed marriage and lower fertility without a proactive economic policy agenda places a burden on cultural exhortation that experience shows it cannot bear."
                    </div>
                    <a href="https://www.thepublicdiscourse.com/2023/07/89603/" class="research-link" target="_blank">Read the essay &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">American Housing Corporation / Form Developers</span>
                        <span class="year">2023-2024</span>
                    </div>
                    <h3>Building Family-Sized Apartments</h3>
                    <p class="authors">Bobby Fijan</p>
                    <p class="description">
                        Philadelphia developer Bobby Fijan documents how financial incentives push developers toward studios and one-bedrooms rather than family-sized units. Advocates for pre-war-style apartment designs with multiple bedrooms and argues the best family housing ideas aren't new&mdash;they're forgotten.
                    </p>
                    <div class="key-finding">
                        <strong>Survey finding:</strong> Bedroom count matters more than virtually any other apartment feature for family formation decisions.
                    </div>
                    <a href="https://www.inquirer.com/real-estate/housing/family-size-apartments-philadelphia-bobby-fijan-20231128.html" class="research-link" target="_blank">Read the interview &rarr;</a>
                </div>

                <div class="research-card">
                    <div class="research-meta">
                        <span class="org">Economic Innovation Group</span>
                        <span class="year">2024</span>
                    </div>
                    <h3>The Urban Family Exodus</h3>
                    <p class="authors">Connor O'Brien</p>
                    <p class="description">
                        Analysis of Census data showing the under-5 population is declining twice as fast in large urban counties compared to other areas. Warns of a "family-exodus doom loop" where declining child populations lead to fewer parents advocating for family-friendly amenities.
                    </p>
                    <div class="key-finding">
                        <strong>Political warning:</strong> "When the population of young kids in a city falls 10 or 20 percent, that's a potential political earthquake."
                    </div>
                    <a href="https://www.yahoo.com/news/americas-progressive-cities-increasingly-childless-090059170.html" class="research-link" target="_blank">Read the coverage &rarr;</a>
                </div>
            </div>

            <div class="research-themes">
                <h3>Common Themes</h3>
                <div class="themes-grid">
                    <div class="theme">
                        <div class="theme-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </div>
                        <h4>Zoning Reform</h4>
                        <p>Allow more housing types&mdash;townhomes, duplexes, small apartments&mdash;in areas currently restricted to single-family homes.</p>
                    </div>
                    <div class="theme">
                        <div class="theme-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                        </div>
                        <h4>Building Code Modernization</h4>
                        <p>Update fire codes to allow single-stair buildings, enabling more efficient layouts with larger, family-friendly units.</p>
                    </div>
                    <div class="theme">
                        <div class="theme-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <h4>Tax & Finance Incentives</h4>
                        <p>Reform tax credits to incentivize family-sized units and reduce marriage penalties in welfare programs.</p>
                    </div>
                    <div class="theme">
                        <div class="theme-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                <path d="M16 3.13a4 4 0 010 7.75"/>
                            </svg>
                        </div>
                        <h4>Developer Incentives</h4>
                        <p>Change the financial calculus so building 2-3 bedroom units makes economic sense for developers.</p>
                    </div>
                </div>
            </div>

            <div class="research-disclaimer">
                <p><strong>Note:</strong> This collection represents a range of policy perspectives. Inclusion does not imply endorsement of all recommendations. The goal is to highlight the emerging conversation around family-friendly housing policy.</p>
            </div>
        </div>
    </section>

    <footer id="about">
        <div class="footer-inner">
            <div class="footer-grid">
                <div class="footer-about">
                    <h3>About This Project</h3>
                    <p>
                        Cities for Families tracks demographic changes in America's urban centers, exploring why cities are losing young children and what can be done to make them more family-friendly. This analysis uses Census Bureau population estimates and the Economic Innovation Group's county typology.
                    </p>
                </div>
                <div class="footer-links">
                    <h4>Data Sources</h4>
                    <ul>
                        <li><a href="https://www.census.gov/programs-surveys/popest.html">Census Bureau Population Estimates</a></li>
                        <li><a href="https://eig.org/">Economic Innovation Group</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Methodology</h4>
                    <ul>
                        <li><a href="#">County Classification</a></li>
                        <li><a href="#">Fertility Rate Calculation</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>
                    Data: U.S. Census Bureau, CC-EST2024-AGESEX and CO-EST2024-ALLDATA.
                    County typology courtesy of the <a href="https://eig.org/" class="credit-link">Economic Innovation Group</a>.
                </p>
            </div>
        </div>
    </footer>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="data/county_data_embed.js"></script>
    <script src="data/fertility_rate_ts.js"></script>
    <script>
        // Color palette for county types
        const typeColors = {
            'Large urban': '#ff6b4a',
            'Mid-sized urban': '#ffa94d',
            'Small urban': '#ffd43b',
            'Suburban': '#69db7c',
            'Small town': '#38d9a9',
            'Rural': '#4dabf7'
        };

        const typeOrder = ['Large urban', 'Mid-sized urban', 'Small urban', 'Suburban', 'Small town', 'Rural'];

        // Build fertility chart
        function buildFertilityChart() {
            const container = document.getElementById('fertility-chart');
            const width = container.clientWidth;
            const height = 400;
            const margin = { top: 20, right: 120, bottom: 40, left: 50 };

            container.innerHTML = '';

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Get all years and rates
            const allYears = [];
            const allRates = [];
            typeOrder.forEach(type => {
                if (fertilityRateTS[type]) {
                    fertilityRateTS[type].forEach(d => {
                        allYears.push(d.year);
                        allRates.push(d.rate);
                    });
                }
            });

            const xScale = d3.scaleLinear()
                .domain([d3.min(allYears), d3.max(allYears)])
                .range([0, chartWidth]);

            const yScale = d3.scaleLinear()
                .domain([40, d3.max(allRates) + 2])
                .range([chartHeight, 0]);

            // Grid lines
            g.append('g')
                .attr('class', 'grid')
                .selectAll('line')
                .data(yScale.ticks(5))
                .join('line')
                .attr('x1', 0)
                .attr('x2', chartWidth)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d))
                .attr('stroke', 'rgba(255,255,255,0.05)')
                .attr('stroke-dasharray', '2,2');

            // Axes
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format('d')).ticks(7))
                .attr('color', '#6e7c8a')
                .selectAll('text')
                .attr('fill', '#6e7c8a');

            g.append('g')
                .call(d3.axisLeft(yScale).ticks(5))
                .attr('color', '#6e7c8a')
                .selectAll('text')
                .attr('fill', '#6e7c8a');

            // Lines
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.rate))
                .curve(d3.curveMonotoneX);

            typeOrder.forEach(type => {
                if (fertilityRateTS[type]) {
                    g.append('path')
                        .datum(fertilityRateTS[type])
                        .attr('fill', 'none')
                        .attr('stroke', typeColors[type])
                        .attr('stroke-width', type === 'Large urban' ? 3 : 2)
                        .attr('stroke-opacity', type === 'Large urban' ? 1 : 0.7)
                        .attr('d', line);

                    // End label
                    const lastPoint = fertilityRateTS[type][fertilityRateTS[type].length - 1];
                    g.append('text')
                        .attr('x', chartWidth + 8)
                        .attr('y', yScale(lastPoint.rate))
                        .attr('dy', '0.35em')
                        .attr('fill', typeColors[type])
                        .attr('font-size', '11px')
                        .attr('font-weight', type === 'Large urban' ? '600' : '400')
                        .text(type);
                }
            });

            // Build legend
            const legendContainer = document.getElementById('chart-legend');
            legendContainer.innerHTML = typeOrder.map(type => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: ${typeColors[type]}"></div>
                    <span>${type}</span>
                </div>
            `).join('');
        }

        buildFertilityChart();
        window.addEventListener('resize', buildFertilityChart);

        // Decline comparison bar chart
        const declineData = [
            { type: 'Large urban', decline: -18.3, rate2011: 55.2, rate2024: 45.1 },
            { type: 'Mid-sized urban', decline: -15.8, rate2011: 55.8, rate2024: 47.0 },
            { type: 'Small urban', decline: -13.0, rate2011: 55.3, rate2024: 48.1 },
            { type: 'Suburban', decline: -10.2, rate2011: 53.4, rate2024: 48.0 },
            { type: 'Small town', decline: -8.5, rate2011: 53.5, rate2024: 49.0 },
            { type: 'Rural', decline: -5.8, rate2011: 54.8, rate2024: 51.6 }
        ];

        function buildDeclineChart() {
            const container = document.getElementById('decline-chart');
            if (!container) return;

            const width = container.clientWidth;
            const height = 400;
            const margin = { top: 20, right: 30, bottom: 100, left: 60 };

            container.innerHTML = '';

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleBand()
                .domain(declineData.map(d => d.type))
                .range([0, chartWidth])
                .padding(0.3);

            const yScale = d3.scaleLinear()
                .domain([-20, 0])
                .range([chartHeight, 0]);

            // Grid lines
            g.append('g')
                .selectAll('line')
                .data([-20, -15, -10, -5, 0])
                .join('line')
                .attr('x1', 0)
                .attr('x2', chartWidth)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d))
                .attr('stroke', 'rgba(255,255,255,0.05)')
                .attr('stroke-dasharray', d => d === 0 ? 'none' : '2,2');

            // Zero line
            g.append('line')
                .attr('x1', 0)
                .attr('x2', chartWidth)
                .attr('y1', yScale(0))
                .attr('y2', yScale(0))
                .attr('stroke', 'rgba(255,255,255,0.2)')
                .attr('stroke-width', 1);

            // Bars
            g.selectAll('rect')
                .data(declineData)
                .join('rect')
                .attr('x', d => xScale(d.type))
                .attr('y', d => yScale(0))
                .attr('width', xScale.bandwidth())
                .attr('height', d => yScale(d.decline) - yScale(0))
                .attr('fill', d => typeColors[d.type])
                .attr('rx', 4);

            // Labels on bars
            g.selectAll('.bar-label')
                .data(declineData)
                .join('text')
                .attr('class', 'bar-label')
                .attr('x', d => xScale(d.type) + xScale.bandwidth() / 2)
                .attr('y', d => yScale(d.decline) + 15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .text(d => d.decline + '%');

            // X axis
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale))
                .attr('color', '#6e7c8a')
                .selectAll('text')
                .attr('fill', '#6e7c8a')
                .attr('font-size', '10px')
                .attr('transform', 'rotate(-35)')
                .attr('text-anchor', 'end')
                .attr('dx', '-0.5em')
                .attr('dy', '0.5em');

            // Y axis
            g.append('g')
                .call(d3.axisLeft(yScale).ticks(5).tickFormat(d => d + '%'))
                .attr('color', '#6e7c8a')
                .selectAll('text')
                .attr('fill', '#6e7c8a');
        }

        buildDeclineChart();
        window.addEventListener('resize', buildDeclineChart);

        // Map
        let currentMode = 'absolute';

        function getAbsoluteColor(value) {
            if (value === null || value === undefined) return '#242b33';
            if (value > 5000) return '#26de81';
            if (value > 2000) return '#7bed9f';
            if (value > 500) return '#c8f7dc';
            if (value > 0) return '#e8fcf1';
            if (value > -2000) return '#ffe4e6';
            if (value > -5000) return '#fca5a5';
            if (value > -15000) return '#f87171';
            if (value > -30000) return '#ef4444';
            return '#dc2626';
        }

        function getPercentColor(value) {
            if (value === null || value === undefined) return '#242b33';
            if (value > 10) return '#26de81';
            if (value > 5) return '#7bed9f';
            if (value > 0) return '#e8fcf1';
            if (value > -5) return '#ffe4e6';
            if (value > -10) return '#fca5a5';
            if (value > -15) return '#f87171';
            return '#dc2626';
        }

        function getFertilityColor(value) {
            if (value === null || value === undefined) return '#242b33';
            if (value > 55) return '#26de81';
            if (value > 50) return '#7bed9f';
            if (value > 45) return '#ffd43b';
            if (value > 40) return '#ffa94d';
            if (value > 35) return '#ff8787';
            return '#ff6b6b';
        }

        function getColor(fips) {
            const data = countyData[fips];
            if (!data) return '#1a1f26';
            if (currentMode === 'absolute') return getAbsoluteColor(data.ac);
            if (currentMode === 'percent') return getPercentColor(data.pc);
            return getFertilityColor(data.fr24);
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return num.toLocaleString();
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            if (currentMode === 'absolute') {
                legend.innerHTML = `
                    <h4>Under-5 Change (Absolute)</h4>
                    <div class="legend-scale">
                        <div style="flex:1;background:#dc2626"></div>
                        <div style="flex:1;background:#f87171"></div>
                        <div style="flex:1;background:#fca5a5"></div>
                        <div style="flex:1;background:#ffe4e6"></div>
                        <div style="flex:1;background:#e8fcf1"></div>
                        <div style="flex:1;background:#7bed9f"></div>
                        <div style="flex:1;background:#26de81"></div>
                    </div>
                    <div class="legend-labels">
                        <span>&lt;-30k</span>
                        <span>0</span>
                        <span>&gt;+5k</span>
                    </div>
                    <div class="note">Gray = non-large urban counties</div>
                `;
            } else if (currentMode === 'percent') {
                legend.innerHTML = `
                    <h4>Under-5 Change (%)</h4>
                    <div class="legend-scale">
                        <div style="flex:1;background:#dc2626"></div>
                        <div style="flex:1;background:#f87171"></div>
                        <div style="flex:1;background:#fca5a5"></div>
                        <div style="flex:1;background:#ffe4e6"></div>
                        <div style="flex:1;background:#e8fcf1"></div>
                        <div style="flex:1;background:#7bed9f"></div>
                        <div style="flex:1;background:#26de81"></div>
                    </div>
                    <div class="legend-labels">
                        <span>&lt;-15%</span>
                        <span>0%</span>
                        <span>&gt;+10%</span>
                    </div>
                    <div class="note">Gray = non-large urban counties</div>
                `;
            } else {
                legend.innerHTML = `
                    <h4>Fertility Rate 2024</h4>
                    <div class="legend-scale">
                        <div style="flex:1;background:#ff6b6b"></div>
                        <div style="flex:1;background:#ff8787"></div>
                        <div style="flex:1;background:#ffa94d"></div>
                        <div style="flex:1;background:#ffd43b"></div>
                        <div style="flex:1;background:#7bed9f"></div>
                        <div style="flex:1;background:#26de81"></div>
                    </div>
                    <div class="legend-labels">
                        <span>&lt;35</span>
                        <span>45</span>
                        <span>&gt;55</span>
                    </div>
                    <div class="note">Births per 1,000 women (15-49)</div>
                `;
            }
        }

        // Load US TopoJSON and render map
        const width = 960;
        const height = 600;

        const svg = d3.select("#map")
            .attr("viewBox", [0, 0, width, height])
            .attr("preserveAspectRatio", "xMidYMid meet");

        const tooltip = d3.select("#tooltip");

        const projection = d3.geoAlbersUsa()
            .scale(1280)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json").then(us => {
            const counties = topojson.feature(us, us.objects.counties);
            const states = topojson.mesh(us, us.objects.states, (a, b) => a !== b);

            svg.append("g")
                .selectAll("path")
                .data(counties.features)
                .join("path")
                .attr("class", d => {
                    const fips = d.id.toString().padStart(5, '0');
                    return countyData[fips] ? "county major" : "county";
                })
                .attr("fill", d => {
                    const fips = d.id.toString().padStart(5, '0');
                    return getColor(fips);
                })
                .attr("d", path)
                .on("mouseover", function(event, d) {
                    const fips = d.id.toString().padStart(5, '0');
                    const data = countyData[fips];
                    if (!data) return;

                    d3.select(this).raise();

                    const absSign = data.ac >= 0 ? '+' : '';
                    const pctSign = data.pc >= 0 ? '+' : '';
                    const absClass = data.ac >= 0 ? 'positive' : 'negative';
                    const pctClass = data.pc >= 0 ? 'positive' : 'negative';

                    tooltip.html(`
                        <div class="county-name">${data.n}, ${data.s}</div>
                        <div class="stat-row">
                            <span class="stat-label">Total Pop. (2020)</span>
                            <span class="stat-value">${formatNumber(data.p0)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Under-5 (2020)</span>
                            <span class="stat-value">${formatNumber(data.u0)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Under-5 (2024)</span>
                            <span class="stat-value">${formatNumber(data.u4)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Absolute Change</span>
                            <span class="stat-value ${absClass}">${absSign}${formatNumber(data.ac)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Percent Change</span>
                            <span class="stat-value ${pctClass}">${pctSign}${data.pc}%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Fertility Rate 2024</span>
                            <span class="stat-value">${data.fr24 ? data.fr24.toFixed(1) : 'N/A'}</span>
                        </div>
                    `);

                    tooltip.classed("visible", true);
                })
                .on("mousemove", function(event) {
                    const container = document.querySelector('.map-container');
                    const rect = container.getBoundingClientRect();
                    let left = event.clientX - rect.left + 15;
                    let top = event.clientY - rect.top + 15;

                    const tooltipRect = tooltip.node().getBoundingClientRect();
                    if (left + tooltipRect.width > rect.width - 20) {
                        left = event.clientX - rect.left - tooltipRect.width - 15;
                    }
                    if (top + tooltipRect.height > rect.height - 20) {
                        top = event.clientY - rect.top - tooltipRect.height - 15;
                    }

                    tooltip.style("left", left + "px").style("top", top + "px");
                })
                .on("mouseout", function() {
                    tooltip.classed("visible", false);
                });

            svg.append("path")
                .datum(states)
                .attr("class", "state-border")
                .attr("d", path);

            window.countyPaths = svg.selectAll(".county");

            updateLegend();
        });

        // Toggle buttons
        document.querySelectorAll('.map-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMode = this.dataset.mode;

                if (window.countyPaths) {
                    window.countyPaths.attr("fill", d => {
                        const fips = d.id.toString().padStart(5, '0');
                        return getColor(fips);
                    });
                }

                updateLegend();
            });
        });

        // Smooth scroll for nav links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
</body>
</html>
